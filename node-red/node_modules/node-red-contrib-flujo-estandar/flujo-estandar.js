module.exports = function(RED) {
    function FlujoEstandarNode(config) {
        RED.nodes.createNode(this, config);
        var node = this;

        // Importar la clase calculadora
        const CalcularFlujoEstandar = require('./CalcularFlujoEstandar');

        // Crear instancia del calculador
        const calculador = new CalcularFlujoEstandar();

        node.on('input', function(msg) {
            try {
                // Extraer parámetros del payload
                const {
                    massFlow,            // kg/h (masa del Coriolis)
                    fluid,               // 'butano', 'propano', 'lpg'
                    observedTempF,       // Temperatura observada en °F
                    observedPressurePSI, // Presión observada en PSIG
                    observedDensity,     // Densidad observada en kg/m³ (del Coriolis)
                    rvp,                 // Reid Vapor Pressure en PSI @ 100°F (del laboratorio)
                    mFactor              // Factor de corrección del medidor (default 1.0)
                } = msg.payload;

                // Validar parámetros requeridos
                if (massFlow === undefined) {
                    throw new Error('Parámetro requerido: massFlow (kg/h)');
                }
                if (!fluid) {
                    throw new Error('Parámetro requerido: fluid (butano/propano/lpg)');
                }
                if (observedTempF === undefined) {
                    throw new Error('Parámetro requerido: observedTempF (°F)');
                }
                if (observedPressurePSI === undefined) {
                    throw new Error('Parámetro requerido: observedPressurePSI (PSIG)');
                }
                if (observedDensity === undefined) {
                    throw new Error('Parámetro requerido: observedDensity (kg/m³)');
                }

                // Llamar al método de conversión
                const result = calculador.convertMassToStandardVolume(
                    massFlow,
                    fluid,
                    observedTempF,
                    observedPressurePSI,
                    observedDensity,
                    rvp || null,
                    mFactor || 1.0
                );

                // Actualizar el mensaje con el resultado
                msg.payload = result;

                // Actualizar estado del nodo
                const mfText = mFactor ? ` MF:${mFactor}` : '';
                const rvpText = rvp ? ` RVP:${rvp}` : '';
                node.status({
                    fill: "green",
                    shape: "dot",
                    text: `CCF:${result.corrections.CCF.toFixed(4)}${mfText}${rvpText}`
                });

                // Enviar el mensaje
                node.send(msg);

            } catch(error) {
                // Mostrar error en el nodo
                node.status({
                    fill: "red",
                    shape: "ring",
                    text: error.message
                });
                node.error("Error al calcular el flujo estándar: " + error.message, msg);
            }
        });

        // Limpiar estado cuando el nodo se cierra
        node.on('close', function() {
            node.status({});
        });
    }

    RED.nodes.registerType("flujo-estandar", FlujoEstandarNode);
}
