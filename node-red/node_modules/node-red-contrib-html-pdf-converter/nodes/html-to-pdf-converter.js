module.exports = function(RED) {
    const fs = require('fs');
    const path = require('path');
    const htmlPdf = require('html-pdf');

    // Pfad zur Zählerdatei
    const counterFilePath = path.join(__dirname, 'pdf-counter.txt');

    // Funktion zum Lesen des Zählerwerts
    function getNextCounterValue(callback) {
        fs.readFile(counterFilePath, 'utf8', (err, data) => {
            let counter = 1;
            if (err && err.code === 'ENOENT') {
                // Zählerdatei existiert noch nicht
                callback(counter);
            } else if (err) {
                // Ein anderer Fehler
                throw err;
            } else {
                // Zählerdatei existiert, lese den Wert
                counter = parseInt(data, 10);
                callback(counter + 1);
            }
        });
    }

    // Funktion zum Speichern des Zählerwerts
    function saveCounterValue(value, callback) {
        fs.writeFile(counterFilePath, value.toString(), 'utf8', callback);
    }

    function HtmlToPdfNode(config) {
        RED.nodes.createNode(this, config);
        var node = this;

        // Setze das Verzeichnis für PDFs
        const pdfDir = path.join(RED.settings.userDir, 'PDFs');

        // Sicherstellen, dass das Verzeichnis existiert
        if (!fs.existsSync(pdfDir)) {
            fs.mkdirSync(pdfDir, { recursive: true });
        }

        this.on('input', function(msg) {
            var html = msg.payload;
            var pdfName = config.pdfName || 'document'; // Default Name, wenn nicht angegeben

            // Hole den nächsten Zählerwert
            getNextCounterValue((counter) => {
                // Erstelle den Dateinamen mit Zählerwert
                const filename = `${pdfName}_${counter}.pdf`;

                // Erstelle den vollständigen Pfad
                const outputPath = path.join(pdfDir, filename);

                // Konvertiere HTML zu PDF
                htmlPdf.create(html).toFile(outputPath, (err, res) => {
                    if (err) {
                        node.error(err, msg);
                        return;
                    }
                    node.log(`PDF gespeichert als: ${res.filename}`);
                    msg.payload = res.filename;

                    // Speichere den neuen Zählerwert
                    saveCounterValue(counter, (err) => {
                        if (err) {
                            node.error('Fehler beim Speichern des Zählerwerts', msg);
                        }
                        node.send(msg);
                    });
                });
            });
        });
    }

    RED.nodes.registerType("html-to-pdf-converter", HtmlToPdfNode);
}
